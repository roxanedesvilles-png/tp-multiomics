---
title: "Analyse Intégrative Multi-Omique – Dataset T2D"
author: "Amory Antao, Hugo Breton, Appoline Nabi, Roxane Desvilles"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.width = 7,
  fig.height = 5
)
library(dplyr)
library(tidyr)
library(ggplot2)
library(tibble)
library(purrr)
library(tidyverse)
library(org.Hs.eg.db)
library(AnnotationDbi)
```

# **1. Contexte et objectifs - Présentation du jeu de données**

# **2. Exploration du dataset**

**Commentaires :**

Chaque bloc (RNA, protéome, cytokynes) contient un nombre distinct de features.

Les échantillons sont partagés et décrits dans sample_info (avec la variable mode : IR vs IS).

```{r}
data_t2d <- readRDS("/Users/roxanedesvilles/Documents/Pharmacie P5 DESCARTES/6A - M2 Bioinformatique biologique (UPc) 2025-2026/S1/UE Bioinformatique des omiques avancées/UE 8 - Production et gestion des big data en biologie/data_t2d.Rds")

# Vérifier les blocs
lapply(data_t2d, dim)

# Nombre d'échantillons et de features
n_samples <- nrow(data_t2d$sample_info)
n_features <- sapply(data_t2d[1:3], ncol)
n_samples; n_features

# Classes disponibles
table(data_t2d$sample_info$mode)
```
**Commentaires :**

Bloc RNA : 8933 features.

Bloc protein : 233 features.

Bloc cytokyne : 66 features.

Il y a 15 échantillons au total. 7 sont insulino-résistants (IR), et 8 sont insulino-sensibles (IS).


# **3. Analyse préliminaire**

## *a.Mise en forme et transformation des données*
Les données du bloc RNA sont log transformées, mais pas normalisées.
```{r}
# RNA : z-score par gène (colonnes)
RNA_scaled <- t(scale(t(data_t2d$RNA)))
```

Les données du bloc protein sont déjà normalisées.
```{r}
# Protein : déjà normalisé, on laisse tel quel
Protein_scaled <- data_t2d$protein
```

De même pout les données du bloc cytokyne, il faut les normaliser avant la visualisation graphique.
```{r}
# Cytokyne : z-score par feature
Cyto_scaled <- t(scale(t(data_t2d$cytokyne)))
```

Ensuite on crée des matrices pivot, plus faciles à manipuler.

```{r}
# tidy_block sur les matrices normalisées
tidy_block <- function(mat, bloc_name) {
  df <- as.data.frame(t(mat)) |> rownames_to_column(var = "Feature")
  df_long <- df |>
    pivot_longer(
      cols = -Feature,
      names_to = "sample",
      values_to = "Value"
    ) |>
    mutate(Bloc = bloc_name)
  return(df_long)
}

rna_long  <- tidy_block(RNA_scaled, "RNA")
prot_long <- tidy_block(Protein_scaled, "protein")
cyto_long <- tidy_block(Cyto_scaled, "cytokyne")

# Fusionner tous les blocs et ajouter infos échantillons
omics_long <- bind_rows(rna_long, prot_long, cyto_long) |>
  left_join(data_t2d$sample_info, by = "sample")
```

## *b. Visualisation des distributions des features*
On traite séparément les data de cytokyne par rapport à RNA et protein, car l'ordre de grandeur des datasets n'est pas le même (question de lisibilité des graphiques).

```{r}
omics_long_rna_prot <- omics_long %>% filter(Bloc %in% c("RNA", "protein"))
omics_long_cyto     <- omics_long %>% filter(Bloc == "cytokyne")
```

### b.1. Par échantillon
D'abord, on visualise RNA + protein ensemble. On génère un graphique sur un échantillon seulement, étant donné la taille du jeu de données.

```{r, fig.width=14, fig.height=7}
# Sous-échantillonnage pour lisibilité (RNA 9000 features)
set.seed(123)
omics_sub <- omics_long_rna_prot %>%
  group_by(Bloc, sample) %>%
  sample_n(500, replace = TRUE) %>%
  ungroup()

# Boxplot par échantillon
ggplot(omics_sub, aes(x = sample, y = Value, fill = Bloc)) +
  geom_boxplot(outlier.size = 0.3) +
  facet_wrap(~Bloc, scales = "free_y") +
  coord_cartesian(ylim = c(-5, 5)) +  # zoom sur valeurs principales
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distribution des features par échantillon",
       y = "Z-score")
```
On regarde ensuite les cytokines. 
```{r, fig.width=14, fig.height=7}
ggplot(omics_long_cyto, aes(x = sample, y = Value, fill = sample)) +
  geom_boxplot(outlier.size = 0.3) +
  coord_cartesian(ylim = c(-0.3, 0.3)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distribution des cytokines par échantillon", y = "Z-score")
```


### b.2. Par classe
De même on regarde d'abord RNA + protein. 
```{r, fig.width=14, fig.height=7}
# RNA + Protein
ggplot(omics_long_rna_prot, aes(x = mode, y = Value, fill = mode)) +
  geom_boxplot(outlier.size = 0.3) +
  facet_wrap(~Bloc, scales = "free_y") +
  theme_bw() +
  labs(title = "Distribution des features par classe (IS/IR)",
       y = "Z-score")
```

Puis cytokyne.
```{r, fig.width=14, fig.height=7}
# Cytokines
ggplot(omics_long_cyto, aes(x = mode, y = Value, fill = mode)) +
  geom_boxplot(outlier.size = 0.3) +
  coord_cartesian(ylim = c(-0.3, 0.3)) +
  theme_bw() +
  labs(title = "Distribution des cytokines par classe (IS/IR)",
       y = "Z-score")
```


### b.3. Par bloc omique
D'abord RNA + protein
```{r, fig.width=14, fig.height=7}
# RNA + Protein
ggplot(omics_long_rna_prot, aes(x = Bloc, y = Value, fill = Bloc)) +
  geom_boxplot(outlier.size = 0.3) +
  theme_bw() +
  labs(title = "Distribution des blocs RNA et Protein",
       y = "Z-score")
```
Puis cytokyne.
```{r, fig.width=14, fig.height=7}
# Cytokines séparé
ggplot(omics_long_cyto, aes(x = Bloc, y = Value, fill = Bloc)) +
  geom_boxplot(outlier.size = 0.3) +
  coord_cartesian(ylim = c(-0.3,0.3)) +  # zoom si nécessaire
  theme_bw() +
  labs(title = "Distribution du bloc Cytokines",
       y = "Z-score")
```

### c. Selection des features

D'abord on calcule le coefficient de variation (CV) pour chaque feature, afin de choisir le seuil de variance le plus pertinent.

```{r, fig.width=14, fig.height=7}
# Fonction pour calculer CV par feature
cv <- function(x) {
  sd(x) / mean(x)
}

# RNA
cv_rna <- apply(data_t2d$RNA, 2, cv)
summary(cv_rna)
hist(cv_rna, breaks=50, main="CV RNA", xlab="Coefficient de variation", col="green")
abline(v=1.5, col="red", lwd=2)

# Protein
cv_prot <- apply(data_t2d$protein, 2, cv)
summary(cv_prot)
hist(cv_prot, breaks=50, main="CV Protein", xlab="Coefficient de variation", col="coral")
abline(v=0, col="red", lwd=2)

# Cytokines
cv_cyto <- apply(data_t2d$cytokyne, 2, cv)
summary(cv_cyto)
hist(cv_cyto, breaks=50, main="CV Cytokine", xlab="Coefficient de variation", col="cyan")
abline(v=0.2, col="red", lwd=2)
```

Pour RNA on choisit un seuil de 1.5.
```{r}
# Calcul CV sur RNA
cv_rna <- apply(data_t2d$RNA, 2, function(x) sd(x)/mean(x))

# Supprimer NA
cv_rna_noNA <- cv_rna[!is.na(cv_rna)]

# Filtrer les features CV > 1.5 en utilisant les noms
rna_filtered <- data_t2d$RNA[, names(cv_rna_noNA)[cv_rna_noNA > 1.5]]

# Recalculer CV sur features filtrées
cv_rna_filtered <- apply(rna_filtered, 2, function(x) sd(x)/mean(x))

# Top 10 features
top10_rna <- sort(cv_rna_filtered, decreasing = TRUE)[1:10]
top10_rna
names(top10_rna)
```
Pour protein on choisit un seuil de 0. 

```{r}
# CV initial pour Protein
cv_prot <- apply(data_t2d$protein, 2, function(x) sd(x)/mean(x))

# Supprimer NA et garder les noms
cv_prot_noNA <- cv_prot[!is.na(cv_prot)]

# Garder seulement les features CV > 2
prot_filtered <- data_t2d$protein[, names(cv_prot_noNA)[cv_prot_noNA > 0]]

# Recalculer CV sur les features filtrées
cv_prot_filtered <- apply(prot_filtered, 2, function(x) sd(x)/mean(x))

# Top 10 features les plus variables
top10_prot <- sort(cv_prot_filtered, decreasing = TRUE)[1:10]
top10_prot
names(top10_prot)
```

```{r}
print(cv_prot_filtered)
```


Pour cytokyne on choisit un seuil de 0.2.
```{r}
# Calcul CV sur Cytokines
cv_cyto <- apply(data_t2d$cytokyne, 2, function(x) sd(x)/mean(x))

# Supprimer NA
cv_cyto_noNA <- cv_cyto[!is.na(cv_cyto)]

# Filtrer features CV > 0.2
cyto_filtered <- data_t2d$cytokyne[, names(cv_cyto_noNA)[cv_cyto_noNA > 0.2]]

# Recalculer CV sur les features filtrées
cv_cyto_filtered <- apply(cyto_filtered, 2, function(x) sd(x)/mean(x))

# Top 10 features les plus variables
top10_cyto <- sort(cv_cyto_filtered, decreasing = TRUE)[1:10]
top10_cyto
names(top10_cyto)
```

```{r}
print(cv_cyto_filtered)
```

```{r}
# Récupérer le symbole des gènes RNA
res_symbol <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = names(cv_rna_filtered),   # noms des gènes RNA
  keytype = "ENSEMBL",
  columns = c("SYMBOL")
)

res_symbol

# Récupérer l'UNIPROT (protéine correspondante)
res_uniprot <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = names(cv_rna_filtered),
  keytype = "ENSEMBL",
  columns = c("UNIPROT")
)

res_uniprot
```
```{r}
res_uniprot$UNIPROT %in% colnames(data_t2d$protein)
```

